<!DOCTYPE>
<html>
<head>
    <title>数据集字段查询统计</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.0.1/css/ol.css">
    <script type="text/javascript" src="https://openlayers.org/en/v4.0.1/build/ol-debug.js"></script>
    <script type="text/javascript" src="../../dist/SuperMapiClient9 for OL3.js"></script>
    <style>
        .ol-popup {
            position: absolute;
            background-color: white;
            -webkit-filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
            filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 280px;
        }
    </style>

    <div id="popup" class="ol-popup">
        <div id="popup-content"></div>
    </div>
</head>
<body onload="init()" style=" margin: 0;overflow: hidden;background: #fff;">
<div id="toolbar" style=" position: relative;padding-top: 10px; padding-bottom: 10px;">
    <span>图层：</span>
    <select id='layerSelect' class="form-control" style='width:200px;margin-top:10px;display: inline-block'></select>
    <span>字段：</span>
    <span style="display: inline-block">
        <select id='fieldSelect' class="form-control" style='width:100px;margin-top:10px;'></select>
    </span>
    <input type="button" class="btn btn-primary" value="统计" onclick="fieldStatistic()"/>
    <input type="button" class="btn btn-primary" value="清除" onclick="clearfieldStatistic()"/>
</div>
<div id="map" style="margin:0 auto;position: relative; height: 510px;border: 1px solid #3473b7;"></div>
</body>

<script type="text/javascript">
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var overlay = new ol.Overlay(({
        element: container,
        autoPan: true,
        autoPanAnimation: {
            duration: 250
        }
    }));
    var map, currentData, layersName = [],
            mapURL = "http://support.supermap.com.cn:8090/iserver/services/map-world/rest/maps/World",
            dataURL = "http://support.supermap.com.cn:8090/iserver/services/data-world/rest/data";

    function init() {
        map = new ol.Map({
            target: 'map',
            view: new ol.View({
                center: [0, 0],
                zoom: 2,
                projection: 'EPSG:4326'
            }),
            overlays: [overlay],
        });
        map.addLayer(new ol.supermap.TiledMapLayer(mapURL, {"pro": "4326"}));
        showLayersInfo();
        document.getElementById("layerSelect").onchange = function () {
            getFields();
        };
    }

    //获取子图层信息
    function showLayersInfo() {
        var subLayer;
        var getLayersInfoService = new ol.supermap.GetLayersInfoService(mapURL);
        getLayersInfoService.on("complete", function (serviceResult) {
            var layers = serviceResult.element.result;
            if (!layers) return;
            for (var i = 0, len = layers.length; i < len; i++) {
                subLayer = layers[i];
                if ("UGC" == subLayer.type) {
                    //记录数据源，数据集信息供字段查询统计使用
                    if (subLayer.datasetInfo.name && subLayer.datasetInfo.dataSourceName) {
                        layersName[i] = {
                            dataSetName: subLayer.datasetInfo.name,
                            dataSourceName: subLayer.datasetInfo.dataSourceName,
                            layerName: subLayer.name
                        };
                    }
                }
            }
            //添加图层信息到选择列表
            var layerSelect = document.getElementById("layerSelect");
            layerSelect.innerHTML = "";
            for (i = 0; i < layersName.length; i++) {
                layerSelect.options[i] = new Option(layersName[i].layerName);
            }
            getFields();
        });
        getLayersInfoService.getLayersInfo();
    }

    function getFields() {
        var layerSelect = document.getElementById("layerSelect");
        var name = layerSelect.options[layerSelect.selectedIndex].innerHTML;
        var dataInfo;
        for (var i = 0; i < layersName.length; i++) {
            dataInfo = layersName[i];
            if (dataInfo.layerName == name) {
                //设置数据集，数据源，查询fields信息
                currentData = dataInfo;
                var getFieldsService = new ol.supermap.GetFieldsService(dataURL, {
                    dataSourceName: dataInfo.dataSourceName, dataSetName: dataInfo.dataSetName
                });
                getFieldsService.on("complete", function (serviceResult) {
                    var fieldNames = serviceResult.element.result.fieldNames;
                    var fieldSelect = document.getElementById("fieldSelect");
                    fieldSelect.innerHTML = "";
                    for (var j = 0; j < fieldNames.length; j++) {
                        fieldSelect.options[j] = new Option(fieldNames[j], fieldNames[j]);
                    }
                });
                getFieldsService.getFields();
            }
        }
    }

    function fieldStatistic() {
        var fieldSelect = document.getElementById("fieldSelect");
        var fieldName = fieldSelect.options[fieldSelect.selectedIndex].innerHTML;
        if (currentData) {
            var fieldStatisticService = new ol.supermap.FieldStatisticService(dataURL, {
                dataSourceName: currentData.dataSourceName,
                dataSetName: currentData.dataSetName,
                fieldName: fieldName
            });
            fieldStatisticService.on("complete", function (serviceResult) {
                showResult(serviceResult.element.result);
            });
            fieldStatisticService.getFieldStatisticInfo();
        }
    }

    function showResult(serviceResult) {
        if (!serviceResult) {
            return;
        }
        var innerHTMLStr = '<div style="line-height: 35px;">'
                + '<strong>字段（' + serviceResult.fieldName + '）统计结果:</strong><div>';
        var keys = ["AVERAGE", "MAX", "MIN", "STDDEVIATION", "SUM", "VARIANCE"];
        var tableStr = "<table id='trafficRes' class='table table-bordered'><tr><td>平均值</td><td>最大值</td><td>最小值</td>"
                + "<td>标准差</td><td>和</td><td>方差</td></tr>";
        var resultTR = "<tr>";
        for (var i = 0; i < keys.length; i++) {
            resultTR += "<td>" + serviceResult[keys[i]] + "</td>";
        }
        resultTR += "</tr>";
        tableStr += resultTR + "</table>";
        innerHTMLStr += tableStr;
        content.innerHTML = innerHTMLStr;
        overlay.setPosition([0, 0]);
    }

    function clearfieldStatistic() {
        overlay.setPosition(undefined);
    }
</script>

</html>
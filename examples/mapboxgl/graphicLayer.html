<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title data-i18n="resources.title_mb_graphicLayer"></title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body style=" margin: 0;overflow: hidden;background: #fff;width: 100%;height:100%">
<div id="map"></div>
<script type="text/javascript" include="papaparse,jquery,dat-gui,widgets" src="../js/include-web.js"></script>
<script type="text/javascript" include="deck" src="../../dist/include-mapboxgl.js"></script>
<script type="text/javascript">
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA';

    var map, graphicLayer;

    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v9',
        center: [-73.91426, 40.7594],
        zoom: 10.64
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-left');

    widgets.loader.showLoader("data loading...");
    $.get('../data/nyc-taxi.csv', function (csvstr) {
        widgets.loader.removeLoader();
        var result = Papa.parse(csvstr, {skipEmptyLines: true, header: true});
        var points = result.data;

        var graphics = [];
        for (var i = 0; i < points.length; i++) {

            var lngLat = {
                lng: parseFloat(points[i].lng),
                lat: parseFloat(points[i].lat)
            };
            //可以单独给要素设置颜色和半径: mapboxgl.supermap.Graphic(lngLat,style);
            graphics.push(new mapboxgl.supermap.Graphic(lngLat));
        }

        var graphicStyle = {
            color: [0, 255, 128],
            radius: 10
        };

        graphicLayer = new mapboxgl.supermap.GraphicLayer("graphic", {
            graphics: graphics,
            radius: graphicStyle.radius,
            color: graphicStyle.color,
            highlightColor: [255, 0, 0, 255],
            onClick: function (e) {

                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML("position:" + "<br>" + JSON.stringify(e.lngLat))
                    .addTo(map);
            }
        });
        graphicLayer.addTo(map);

        initDatGui(graphicStyle)
    });

    //设置面板
    function initDatGui(options) {
        var gui = new dat.GUI();
        var Control = createConfigControl();
        map.addControl(new Control(gui.domElement), 'top-right');

        gui.addColor(options, 'color').onChange(finished);
        gui.add(options, 'radius', 0, 100).onChange(finished);

        function finished() {
            graphicLayer.setStyle(options);
        }

    }

    //创建图层操作控件
    function createConfigControl() {
        function ConfigControl(domElement) {
            this.dom = domElement;
        }

        ConfigControl.prototype.onAdd = function (map) {
            this._map = map;
            this._container = this.dom;
            this._container.className = 'mapboxgl-ctrl ' + this._container.className;
            return this._container;
        };

        ConfigControl.prototype.onRemove = function () {
            this._container.parentNode.removeChild(this._container);
            this._map = undefined;
        };
        return ConfigControl;
    }


</script>
</body>
</html>

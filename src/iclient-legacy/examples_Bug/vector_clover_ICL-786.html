<!DOCTYPE html>
<html>
<head>
    <title>三叶草符号</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <style type="text/css">
        body {
            margin: 0;
            overflow: hidden;
            background: #fff;
        }

        #map {
            height: 510px;
            position: relative;
            border-top: 1px solid #3473b7;
            border-bottom: 1px solid #3473b7;
        }

        #toolbar {
            position: relative;
            padding-top: 5px;
            padding-bottom: 10px;
        }
    </style>
    <script type="text/javascript" src="../libs/SuperMap.Include.js"></script>
    <script type="text/javascript">
        var featuresOrigin = [];
        var map, layer,vector,host = document.location.toString().match(/file:\/\//) ? "http://localhost:8090" : 'http://' + document.location.host,
        url = host + "/iserver/services/map-china400/rest/maps/China", clickedPoint, selectedSector;
        //高亮时，顶部的扇叶所使用的样式，选用的是旋转了270度的扇形
        var styleTop = {
            strokeColor: "#000",
            fillColor: 'red',
            strokeOpacity: 1,
            strokeWidth: 0.5,
            pointRadius: 15,
            pointerEvents: "visiblePainted",
            //形状为扇形
            graphicName:'sector',
            //旋转270度
            rotation: 270
        };
        //高亮时，左下角的扇叶所使用的样式，选用的是旋转了150度的扇形
        var styleLeft = {
            strokeColor: "#000",
            fillColor: 'green',
            strokeOpacity: 1,
            strokeWidth: 0.5,
            pointRadius: 15,
            pointerEvents: "visiblePainted",
            //形状为扇形
            graphicName:'sector',
            //旋转150度
            rotation: 150
        };
        //高亮时，右下角的扇叶所使用的样式，选用的是旋转了300度的扇形
        var styleRight = {
            strokeColor: "#000",
            fillColor: 'blue',
            strokeOpacity: 1,
            strokeWidth: 0.5,
            pointRadius: 15,
            pointerEvents: "visiblePainted",
            //形状为扇形
            graphicName:'sector',
            //旋转30度
            rotation: 30
        };
        //三叶草所使用的样式
        var styleClover = {
            strokeColor: "#000",
            fillColor: '#545BF4',
            strokeOpacity: 1,
            strokeWidth: 0.5,
            pointRadius: 15,
            pointerEvents: "visiblePainted",
            //图形形状为三叶草
            graphicName:'clover'
        };
        function init(){
            map = new SuperMap.Map("map", {controls:[
                new SuperMap.Control.LayerSwitcher(),
                new SuperMap.Control.ScaleLine(),
                new SuperMap.Control.PanZoomBar({showSlider:true}),
                new SuperMap.Control.Navigation({
                    dragPanOptions: {
                        enableKinetic: true
                    }
                })]
            });
            layer = new SuperMap.Layer.TiledDynamicRESTLayer("china",url, {transparent: true, cacheEnabled: true},{scales:[90000000,50000000,10000000,5000000,1000000,500000, 250000,100000, 50000, 25000,10000]});
            layer.events.on({"layerInitialized": addLayer});
            //在不需要太多的移动地图让要素重绘的情况下，选用Canvas比Canvas2的绘制效率更高
            vector = new SuperMap.Layer.Vector("Vector Layer",{renderers:["Canvas"]});
        }
        function addLayer() {
            map.addLayers([layer, vector]);
            //这里必须开启"allowSelectTheSameFeature"属性，才能在一个要素上多次点击，以实现点击三叶草不同的扇区的功能
            select = new SuperMap.Control.SelectFeature(vector, {onSelect: onFeatureSelect, onUnselect: onFeatureUnselect,allowSelectTheSameFeature:true});
            map.addControl(select);
            map.setCenter(new SuperMap.LonLat(0,0),0);
            select.activate();
        }

        //创建3000个三叶草符号
        function addSectors(){
            //计时
            var dateTime0 = new Date().getTime();
            var featuresSector=[];
            for(var i =0;i < 3000; i++){
                var p0_sign = Math.random()<= 0.5 ? true:false ,p1_sign = Math.random()<= 0.5 ? true:false;
                var p0 = Math.random()*10000000, p1 = Math.random()*3000000;
                p0 = p0_sign? p0:-p0;
                p1 = p1_sign? p1:-p1;
                //创建一个组合的三叶草形状
                featuresSector.push(createSectorMarker([p0, p1]));
            }
            vector.addFeatures(featuresSector);
            var dateTime1 = new Date().getTime();
            console.info("9000个扇叶的创建添加时间:"+(dateTime1-dateTime0)+"ms");
            return featuresSector;
        }

        //绘制三叶草函数
        function createSectorMarker(point){
            var sector = new SuperMap.Feature.Vector(
                    new SuperMap.Geometry.Point(point[0],point[1]),
                    {},
                    styleClover
            );
            return sector;
        }
        //要素被选中时调用此函数
        function onFeatureSelect(feature,evt) {
            selectedFeature = feature;
            var lonlat = map.getLonLatFromPixel(evt.xy);
            var x = feature.geometry.x, y = feature.geometry.y;
            var style,info;
            //根据点击的位置相对于要素中心点的方位，可判断出被点击的是哪个扇叶
            if((lonlat.lat - y) > 0 ){
                style = styleTop;
                info = "top";
            }else if((lonlat.lon - x) < 0){
                style = styleLeft;
                info = 'left';
            }else{
                style = styleRight;
                info = 'right';
            }
            var point = new SuperMap.Geometry.Point(x,y);
            //在图层上添加一个扇叶来实现高亮
            selectedSector = new SuperMap.Feature.Vector(point,null,style);
            vector.addFeatures(selectedSector);
            var contentHTML = "<div style='font-size:.8em; opacity: 0.8; overflow-y:hidden;'>" +
                    "<span style='font-weight: bold; font-size: 18px;'>详细信息" + " " + info + "</span><br>";
            contentHTML +="</div>";
            //初始化一个弹出窗口，当某个地图要素被选中时会弹出此窗口，用来显示选中地图要素的属性信息
            popup = new SuperMap.Popup.FramedCloud("chicken",
                    map.getLonLatFromPixel(evt.xy),
                    null,
                    contentHTML,
                    null,
                    true);
            feature.popup = popup;
            map.addPopup(popup);
        }
        //清除要素时调用此函数
        function onFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
            //在图层上删除一个高亮扇叶来实现取消高亮
            selectedSector && vector.removeFeatures(selectedSector);
            selectedSector = null;
        }

        function clearAllFeatures(){
            vector.removeAllFeatures();
            selectedSector = null;
        }

    </script>
</head>
<body onload="init();">
<div id="toolbar">
    <input type="button" class="btn" value="标注三叶草符号" onclick="addSectors()"/>
    <input type="button" class="btn" value="清除" onclick="clearAllFeatures()"/>
</div>
<div id="map"></div>
</body>
</html>